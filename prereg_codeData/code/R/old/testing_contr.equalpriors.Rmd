---
title: "issue_contrequalprior"
output: html_document
date: "2024-02-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

I have some questions about the contr.equalprior function. Below I simulate some data, and run a brms model:

```{r setup}
library(emmeans)
library(easystats)
library(brms)
library(tidyverse)

# set-up:
project_seed = 2049
set.seed(project_seed) 

# Make df, with 12 subjects, with:
# Group (between subj factor): levels "fam" and "unfam"
# TestSpeaker (within): levels 1,2,3
# sleepState (between): levels awake, activesleep, quietsleep
# MMR: dependent variable
df = structure(list(Subj = structure(c(1L, 1L, 1L, 2L, 2L, 2L, 3L, 
                                       3L, 3L, 4L, 4L, 4L, 5L, 5L, 5L, 6L, 6L, 6L, 7L, 7L, 7L, 8L, 8L, 
                                       8L, 9L, 9L, 9L, 10L, 10L, 10L, 11L, 11L, 11L, 12L, 12L, 12L), 
                                     levels = c("Subj01","Subj02", "Subj03", "Subj04", "Subj05", "Subj06", 
                                                "Subj07", "Subj08","Subj09", "Subj10", "Subj11", "Subj12"), 
                                     class = "factor"),
                    Group = structure(c(1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
                                        1L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
                                        2L, 2L, 2L), levels = c("fam", "unfam"), class = "factor"), 
                    TestSpeaker = structure(c(1L, 2L, 3L, 1L, 2L, 3L, 1L, 2L, 3L, 1L, 2L, 3L, 1L, 2L, 3L, 1L, 2L, 
                                              3L, 1L, 2L, 3L, 1L, 2L, 3L, 1L, 2L, 3L, 1L, 2L, 3L, 1L, 2L, 3L, 
                                              1L, 2L, 3L), levels = c("1", "2", "3"), class = "factor"),
                    MMR = c(38.3193739833394,-26.3345733319488, -36.5391489690257, 17.6727210461579, 13.0723969801114, 
                            -4.24116674572545, 21.2481968372323, 11.4709975141478, 1.82856457361663, 
                            43.7294164718069, 20.3131479540544, 0.785675781481198, -2.15902787287105, 
                            -25.4903371611785, 61.873025266565, 9.06733331354276, -18.7574284113092, 
                            6.33216574768327, -34.9097027199614, -3.96327639212982, 15.9747552016853, 
                            -38.801070417319, -6.46518128748102, -22.630432474398, 21.9291933267653, 
                            24.4946719999554, -31.2847387815119, -8.04032285881707, 14.2321054924562, 
                            8.80183458992482, 18.9550435474235, 33.2621031208136, -11.4198082197363, 
                            -14.7150081652997, 29.2510483128696, -31.1494998323233), 
                    sleepState = structure(c(2L,2L, 2L, 3L, 3L, 3L, 2L, 2L, 2L, 2L, 2L, 2L, 3L, 3L, 3L, 1L, 1L, 
                                             1L, 1L, 1L, 1L, 1L, 1L, 1L, 3L, 3L, 3L, 1L, 1L, 1L, 2L, 2L, 2L, 
                                             1L, 1L, 1L), levels = c("activesleep", "awake", "quietsleep"), class = "factor")),
               row.names = c(NA,-36L), class = c("tbl_df", "tbl", "data.frame"))


# contrasts(df$TestSpeaker) <- contr.equalprior
# contrasts(df$Group) <- contr.equalprior
# contrasts(df$sleepState) <- contr.equalprior




model = brm(MMR ~ 1 + TestSpeaker * Group + 
        sleepState * TestSpeaker + 
        (1 + TestSpeaker * Group | Subj),
      data = df,
      family = gaussian(), 
      prior = c(set_prior("normal(5.97, 23.34)",  
                          class = "Intercept"),
                set_prior("normal(0, 23.34)",  
                          class = "b"),
                set_prior("normal(0, 23.34)",  
                          class = "sigma")),
      init = "random",
      control = list(
        adapt_delta = .99, 
        max_treedepth = 15
      ),
      chains = 4,
      iter = 4000,
      warmup = 2000,
      thin = 1,
      algorithm = "sampling", 
      cores = 4, 
      seed = project_seed
  )

summary(model)
```

I now use the package emmeans() to calculate custom contrasts. First, with the standard (treatment) coding:

```{r contrasts}
# setup custom contrasts:
unfam2 = c(0,0,0,1,0,0)
fam1 = c(1,0,0,0,0,0)
unfam3 = c(0,0,0,0,0,1)
unfam1 = c(0,1,0,0,0,0)

custom_contrasts_group_speaker <- list(
  list("unfam2-fam1" = unfam2 - fam1),
  list("unfam2-unfam3" = unfam2 - unfam3),
  list("unfam1-unfam2" = unfam1 - unfam2)
) 

# custom_contrasts_sleep <- list(
#   list("awake - activesleep and quietsleep" = c(1, -1/2, -1/2)),
#   list("quietsleep - awake and activesleep" = c(-1/2, -1/2, 1)),
#   list("quietsleep vs activesleep" =c(0, 1, -1))
# )

options(contrasts = c("contr.treatment", "contr.poly"))
m_prior_treatment <- unupdate(model) # sample priors from model
m_prior_treatment_pairwise <-
  m_prior_treatment %>%
  emmeans(~ Group:TestSpeaker) 

contrast(m_prior_treatment_pairwise, method = custom_contrasts_group_speaker)
est = contrast(m_prior_treatment_pairwise, method = custom_contrasts_group_speaker)
point_estimate(est, centr = "mean", disp = TRUE) # give me the priors on the contrasts:


```
Then we see that the priors on the contrasts are not equal, so I set the contrasts globally, once with contr.equalprior and once with contr.equalprior_pairs

```{r contrasts}

#model =  readRDS(here("data", "model_output/old", "samples_MMR_rec_orig.rds"))

model = brm(MMR ~ 1 + TestSpeaker * Group + mumDistTrainS * TestSpeaker + mumDistNovelS * TestSpeaker + timeVoiceFam * TestSpeaker * Group + nrSpeakersDaily * TestSpeaker * Group + (1 + TestSpeaker * Group | Subj) ,
      data = dat_rec,
      family = gaussian(), 
      prior = c(set_prior("normal(5.97, 23.34)",  
                          class = "Intercept"),
                set_prior("normal(0, 23.34)",  
                          class = "b"),
                set_prior("normal(0, 23.34)",  
                          class = "sigma")),
      init = "random",
      control = list(
        adapt_delta = .99, 
        max_treedepth = 15
      ),
      chains = 4,
      iter = 4000,
      warmup = 2000,
      thin = 1,
      algorithm = "sampling", 
      cores = 4, 
      seed = project_seed
  )





print("Results for contr.equalprior")

options(contrasts = c("contr.equalprior", "contr.poly"))
m_prior_equalprior <- unupdate(model) # sample priors from model
m_prior_equalprior_pairwise <-
  m_prior_equalprior %>%
  emmeans(~ TestSpeaker)  %>%
  pairs()

#contrast(m_prior_equalprior_pairwise, method = custom_contrasts_group_speaker)
#est = contrast(m_prior_equalprior_pairwise, method = custom_contrasts_group_speaker)
# point_estimate(m_prior_equalprior_pairwise, centr = "mean", disp = TRUE)
point_estimate(m_prior_equalprior_pairwise, centr = "mean", disp = TRUE)

print("Results for contr.equalprior_pairs")

options(contrasts = c("contr.equalprior_pairs", "contr.poly"))
m_prior_equalpriorpairs <- unupdate(model) # sample priors from model
m_prior_equalpriorpairs_pairwise <-
  m_prior_equalpriorpairs %>%
  emmeans(~ TestSpeaker) %>%
  pairs()

#contrast(m_prior_equalpriorpairs_pairwise, method = custom_contrasts_group_speaker)
#est = contrast(m_prior_equalprior_pairwise, method = custom_contrasts_group_speaker)
#point_estimate(m_prior_equalpriorpairs_pairwise)
point_estimate(m_prior_equalpriorpairs_pairwise, centr = "mean", disp = TRUE)



```

Now my questions:
I don't understand why the contrasts for contr.equalprior and contr.equalprior_pairs are different





One final comment: If I run the model without specifying `contr.equalprior` beforehand, and I include `save_pars = save_pars(all = TRUE)` in the `brm()` command, and I then set contr.equalprior globally with `options(contrasts = c("contr.equalprior", "contr.poly"))` before running `emmean()`, it does not work anymore






